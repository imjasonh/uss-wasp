name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Needed for proper diff analysis
    
    - name: Use Node.js 23.x
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
      with:
        node-version: 23.x
        cache: 'npm'
    
    - name: Cache node_modules
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: ~/.npm
        key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          npm-${{ runner.os }}-
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Run linting
      run: npm run lint
    
    - name: Check formatting
      run: npm run format:check
    
    - name: Type check
      run: npm run typecheck
    
    - name: Build project
      run: npm run build
    
    - name: Build web bundle
      run: npm run build:web
    
    - name: Run tests
      run: npm run test -- --coverage --collectCoverageFrom="src/**/*.ts" --coverageReporters=text-summary
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
    
    - name: Cache Playwright browsers
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          playwright-${{ runner.os }}-
    
    - name: Run E2E tests
      run: npm run test:e2e -- --project=chromium
      env:
        CI: true
    
    - name: Upload Playwright report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    
    - name: Comprehensive AI validation
      run: |
        echo "ü§ñ Running comprehensive AI validation..."
        echo "Running basic AI functionality tests..."
        npm run test:ai || echo "‚ö†Ô∏è Basic AI tests completed with issues"
        echo ""
        echo "Running strict AI regression tests..."
        npm run test:ai:strict
        echo ""
        echo "Running AI system gap analysis..."
        npm run test:ai:gaps || echo "‚ö†Ô∏è AI gaps analysis completed (expected gaps may exist)"
        echo ""
        echo "‚úÖ AI validation suite completed"
    
    - name: Security audit
      run: npm audit --audit-level moderate
      continue-on-error: true
    
    - name: Check for large files
      run: |
        echo "üìÅ Checking for large files..."
        large_files=$(find . -type f -size +100k -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./coverage/*" | wc -l)
        if [ $large_files -gt 0 ]; then
          echo "‚ö†Ô∏è Found $large_files large files. Consider if they are necessary."
          find . -type f -size +100k -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./coverage/*" | head -5
        else
          echo "‚úÖ No large files detected"
        fi
    
    - name: Validate commit messages (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo "üí¨ Checking commit message format..."
        git log --oneline origin/main..HEAD | while read line; do
          if ! echo "$line" | grep -qE "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+"; then
            echo "‚ö†Ô∏è Commit message may not follow conventional commits: $line"
          fi
        done
        echo "‚úÖ Commit message validation completed"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false